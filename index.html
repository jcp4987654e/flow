<!DOCTYPE html>
<html lang="es" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FocusFlow Pro | Tareas, Horarios y Metas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --color-primary: 139 92 246; /* violet-500 */
            --color-primary-accent: 124 58 237; /* violet-600 */
            --color-primary-light: 237 233 254; /* violet-100 */
        }
        body { font-family: 'Inter', sans-serif; }
        .task-card, .view-header, .modal-content, .confirm-modal-content, .goal-card, .stat-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .task-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px -5px rgba(var(--color-primary), 0.2);
        }
        .modal-backdrop, .confirm-modal-backdrop { transition: opacity 0.3s ease; }
        .progress-bar-fill { transition: stroke-dashoffset 0.8s cubic-bezier(0.25, 1, 0.5, 1); }
        .completed-task { text-decoration: line-through; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-fadeInUp { animation: fadeInUp 0.5s ease-out forwards; }
        .animate-fadeIn { animation: fadeIn 0.4s ease-out forwards; }
        .schedule-grid {
            display: grid;
            grid-template-columns: 50px repeat(7, minmax(100px, 1fr)); /* Min width for columns */
            grid-template-rows: auto repeat(48, 40px);
            user-select: none;
        }
        .time-indicator { grid-column: 2 / span 7; pointer-events: none; }
        #avatar-container {
            transition: transform 0.3s ease;
        }
        #avatar-container:hover {
            transform: scale(1.05);
        }
        #robot-avatar path {
            transition: d 0.3s ease-in-out;
        }
        .schedule-cell {
            position: relative;
            overflow: hidden;
            white-space: nowrap;
            padding: 2px 4px; 
        }
        .schedule-cell:focus, .schedule-cell.selected {
            outline: 2px solid rgb(var(--color-primary-accent));
            box-shadow: 0 0 10px rgba(var(--color-primary), 0.3);
            z-index: 10;
        }
        .context-menu {
            position: absolute;
            z-index: 1000;
            background-color: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
            padding: 8px;
            min-width: 180px;
        }
        .context-menu-item {
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 4px;
            display: flex;
            align-items: center;
        }
        .context-menu-item:hover {
            background-color: #f1f5f9;
        }
        .color-palette {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 4px;
            margin-top: 8px;
        }
        .color-swatch {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: transform 0.2s;
        }
        .color-swatch:hover {
            transform: scale(1.1);
        }
        .fill-handle {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: rgb(var(--color-primary-accent));
            border: 2px solid white;
            bottom: -2px;
            right: -2px;
            cursor: crosshair;
            z-index: 20;
            display: none;
        }
        .schedule-cell.selected .fill-handle {
            display: block;
        }
        .cell-highlight-fill {
            box-shadow: inset 0 0 0 2px rgb(var(--color-primary-accent));
            background-color: rgba(var(--color-primary), 0.1);
        }
        .progress-circle-bg {
            fill: none;
            stroke: #e2e8f0; /* slate-200 */
        }
        .dark .progress-circle-bg {
            stroke: #334155; /* slate-700 */
        }
        .progress-circle-fg {
            fill: none;
            stroke: rgb(var(--color-primary-accent));
            stroke-linecap: round;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
            transition: stroke-dashoffset 0.5s ease-out;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-700 dark:bg-slate-900 dark:text-slate-300">

    <!-- Contenedor Principal -->
    <div class="min-h-screen flex flex-col lg:flex-row">

        <!-- Barra lateral de Navegaci√≥n -->
        <aside class="bg-white dark:bg-slate-800 w-full lg:w-64 p-6 border-b lg:border-r border-slate-200 dark:border-slate-700 flex-shrink-0 flex flex-col">
            <div class="flex justify-between items-center">
                <h1 class="text-2xl font-bold text-[rgb(var(--color-primary-accent))]">FocusFlow</h1>
                <button id="fullscreen-toggle" class="w-8 h-8 flex items-center justify-center rounded-full text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-700">
                    <svg id="icon-enter-fullscreen" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.5 2A1.5 1.5 0 003 3.5v3A1.5 1.5 0 004.5 8h3A1.5 1.5 0 009 6.5v-3A1.5 1.5 0 007.5 2h-3zM3 10a.5.5 0 01.5.5v3a.5.5 0 00.5.5h3a.5.5 0 010 1h-3A1.5 1.5 0 013 13.5v-3a.5.5 0 01.5-.5zM10 3.5a.5.5 0 01.5-.5h3a.5.5 0 01.5.5v3a.5.5 0 01-1 0v-3a.5.5 0 00-.5-.5h-3a.5.5 0 01-.5-.5zM15 10a.5.5 0 01.5.5v3a.5.5 0 01-.5.5h-3a.5.5 0 010-1h3a.5.5 0 00.5-.5v-3a.5.5 0 01.5-.5z" clip-rule="evenodd" /></svg>
                    <svg id="icon-exit-fullscreen" class="h-5 w-5 hidden" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 6.5A1.5 1.5 0 014.5 5h3A1.5 1.5 0 019 6.5v3A1.5 1.5 0 017.5 11h-3A1.5 1.5 0 013 9.5v-3zM14.5 3a.5.5 0 01.5.5v3a.5.5 0 01-1 0v-3a.5.5 0 00-.5-.5h-3a.5.5 0 010-1h3a1.5 1.5 0 011.5 1.5zM4.5 10a.5.5 0 01.5.5v3a.5.5 0 01-1 0v-3a.5.5 0 00-.5-.5h-3a.5.5 0 010-1h3a1.5 1.5 0 011.5 1.5zM10 14.5a.5.5 0 01.5-.5h3a.5.5 0 01.5.5v3a.5.5 0 01-1 0v-3a.5.5 0 00-.5-.5h-3a.5.5 0 01-.5-.5z" clip-rule="evenodd" /></svg>
                </button>
            </div>
            <nav class="mt-8 flex-grow">
                <h2 class="text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider">Vistas</h2>
                <div class="mt-4 space-y-2">
                    <a href="#" id="view-schedule" class="view-btn flex items-center px-3 py-2 text-sm font-medium rounded-md text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700">
                        <svg class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor"><path d="M.75 5.25A2.25 2.25 0 013 3h14a2.25 2.25 0 012.25 2.25v9.5A2.25 2.25 0 0117 17H3A2.25 2.25 0 01.75 14.75v-9.5zM3 4.5a.75.75 0 00-.75.75v9.5c0 .414.336.75.75.75h14a.75.75 0 00.75-.75v-9.5a.75.75 0 00-.75-.75H3z" /></svg>
                        Horarios
                    </a>
                    <a href="#" id="view-daily" class="view-btn flex items-center px-3 py-2 text-sm font-medium rounded-md bg-[rgba(var(--color-primary-light))] text-[rgb(var(--color-primary-accent))]">
                        <svg class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" /></svg>
                        Diaria
                    </a>
                    <a href="#" id="view-weekly" class="view-btn flex items-center px-3 py-2 text-sm font-medium rounded-md text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700">
                        <svg class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor"><path d="M11 17a1 1 0 001.447.894l4-2A1 1 0 0017 15V5a1 1 0 00-1.447-.894l-4 2A1 1 0 0011 7v10zM4 17a1 1 0 001.447.894l4-2A1 1 0 0010 15V5a1 1 0 00-1.447-.894l-4 2A1 1 0 004 7v10z" /></svg>
                        Semanal
                    </a>
                     <a href="#" id="view-monthly" class="view-btn flex items-center px-3 py-2 text-sm font-medium rounded-md text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700">
                        <svg class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.5 3A2.5 2.5 0 003 5.5v2.879a2.5 2.5 0 00.732 1.767l6.5 6.5a2.5 2.5 0 003.536 0l2.878-2.878a2.5 2.5 0 000-3.536l-6.5-6.5A2.5 2.5 0 0010.379 3H5.5zM6 7a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" /></svg>
                        Mensual
                    </a>
                    <a href="#" id="view-goals" class="view-btn flex items-center px-3 py-2 text-sm font-medium rounded-md text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700">
                         <svg class="h-5 w-5 mr-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M15.28 5.22a.75.75 0 00-1.06 0l-6.5 6.5-2.72-2.72a.75.75 0 00-1.06 1.06l3.25 3.25a.75.75 0 001.06 0l7-7a.75.75 0 000-1.06z" clip-rule="evenodd" /></svg>
                        Metas
                    </a>
                    <a href="#" id="view-stats" class="view-btn flex items-center px-3 py-2 text-sm font-medium rounded-md text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700">
                        <svg class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor"><path d="M10 3.5A1.5 1.5 0 0111.5 5v1.618a3.5 3.5 0 015.153 2.533A3.5 3.5 0 0116.5 15H3.5a3.5 3.5 0 01-1.806-6.35A3.5 3.5 0 016.5 5.118V5A1.5 1.5 0 018 3.5h2zM12 5V4H8v1h4z" /></svg>
                        Estad√≠sticas
                    </a>
                    <a href="#" id="view-pomodoro" class="view-btn flex items-center px-3 py-2 text-sm font-medium rounded-md text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700">
                        <svg class="h-5 w-5 mr-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm.75-13a.75.75 0 00-1.5 0v5c0 .414.336.75.75.75h4a.75.75 0 000-1.5h-3.25V5z" clip-rule="evenodd" /></svg>
                        Pomodoro
                    </a>
                </div>
            </nav>
            <div class="mt-6 space-y-4">
                 <div>
                    <label class="text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase">Tema</label>
                    <div class="flex space-x-2 mt-2">
                        <button class="theme-dot w-6 h-6 rounded-full bg-violet-500 ring-2 ring-offset-2 ring-violet-500 ring-offset-white dark:ring-offset-slate-800" data-color="139 92 246"></button>
                        <button class="theme-dot w-6 h-6 rounded-full bg-rose-500" data-color="244 63 94"></button>
                        <button class="theme-dot w-6 h-6 rounded-full bg-amber-500" data-color="245 158 11"></button>
                        <button id="dark-mode-toggle" class="w-6 h-6 flex items-center justify-center rounded-full bg-slate-200 dark:bg-slate-700">
                            <svg class="h-4 w-4 text-slate-600 dark:text-slate-300" id="moon-icon" viewBox="0 0 20 20" fill="currentColor"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z" /></svg>
                            <svg class="h-4 w-4 text-slate-600 dark:text-slate-300 hidden" id="sun-icon" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 14.464A1 1 0 106.465 13.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm-1.414-2.12a1 1 0 011.414 0l.707.707a1 1 0 11-1.414 1.414l-.707-.707a1 1 0 010-1.414zM4 11a1 1 0 100-2H3a1 1 0 100 2h1z" clip-rule="evenodd" /></svg>
                        </button>
                    </div>
                </div>
                <button id="deleteAllBtn" class="w-full text-rose-500 flex items-center justify-center px-3 py-2 rounded-md font-medium hover:bg-rose-50 dark:hover:bg-rose-500/10 transition-colors">
                    <svg class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                    Limpiar Tareas
                </button>
            </div>
        </aside>

        <!-- Contenido Principal -->
        <main class="flex-1 p-4 sm:p-6 lg:p-8 pb-24">
            <div id="main-content" class="animate-fadeIn"></div>
        </main>
    </div>

    <!-- Modales y elementos flotantes -->
    <div id="modal-container"></div>
    <div id="avatar-container" class="fixed bottom-5 left-1/2 -translate-x-1/2 flex items-end space-x-2 cursor-pointer z-40"></div>
    <div id="context-menu-container"></div>


    <script>
    // --- SCRIPT COMPLETO DE LA APLICACI√ìN ---
    document.addEventListener('DOMContentLoaded', () => {
        // --- ESTADO Y DATOS ---
        let tasks = JSON.parse(localStorage.getItem('tasks')) || [];
        let goals = JSON.parse(localStorage.getItem('goals')) || [];
        let scheduleData = JSON.parse(localStorage.getItem('scheduleData')) || {};
        let currentView = 'daily';
        
        let pomodoroSettings = JSON.parse(localStorage.getItem('pomodoroSettings')) || { work: 25, break: 5 };
        let pomodoro = { timer: null, timeLeft: pomodoroSettings.work * 60, isActive: false, mode: 'work' };
        
        const CATEGORIES = {
            work:     { label: 'Trabajo',  color: '#3b82f6', light: '#dbeafe', keywords: ['trabajo', 'reuni√≥n', 'proyecto', 'email', 'reporte', 'llamada'], emoji: 'üíº' },
            personal: { label: 'Personal', color: '#14b8a6', light: '#ccfbf1', keywords: ['comprar', 'amigos', 'familia', 'cita', 'mandado', 'limpiar'], emoji: 'üè†' },
            study:    { label: 'Estudio',  color: '#f59e0b', light: '#fef3c7', keywords: ['estudiar', 'clase', 'leer', 'curso', 'aprender', 'examen'], emoji: 'üìö' },
            health:   { label: 'Salud',    color: '#f43f5e', light: '#ffe4e6', keywords: ['ejercicio', 'gimnasio', 'correr', 'meditar', 'doctor', 'salud'], emoji: 'üí™' },
        };

        const MESSAGES = {
            noTasks: [
                "Un lienzo en blanco. ¬øQu√© obra maestra crearemos hoy?",
                "¬°D√≠a nuevo, metas nuevas! A√±ade tu primera tarea para empezar.",
                "Mi sistema est√° listo. ¬øCu√°l es el plan para hoy?",
                "¬°Hola! Soy Flowy. ¬°Vamos a organizar este d√≠a juntos!"
            ],
            startDay: [
                "La lista est√° lista. ¬°Un peque√±o paso es todo lo que se necesita para empezar!",
                "¬°El primer paso es el m√°s importante! ¬øA por cu√°l vamos?",
                "¬°Un d√≠a productivo te espera! ¬øEmpezamos?",
                "¬°Todo listo para triunfar! ¬øCu√°l es la primera misi√≥n?"
            ],
            inProgress: [
                "¬°Excelente progreso! Sigamos as√≠.",
                "¬°Una tarea menos, un paso m√°s cerca de tus metas!",
                "¬°Est√°s en racha! No te detengas ahora.",
                "¬°Cada tarea completada es una victoria! ¬°Vamos por la siguiente!"
            ],
            almostDone: [
                "¬°Ya casi lo tienes! ¬°El √∫ltimo esfuerzo vale la pena!",
                "¬°Est√°s a punto de lograrlo! ¬°Qu√© gran d√≠a!",
                "Solo queda un poco m√°s. ¬°Puedes hacerlo!",
                "¬°La recta final! ¬°Vamos a terminar con fuerza!"
            ],
            allDone: [
                "¬°Misi√≥n cumplida! Has conquistado el d√≠a. ¬°A descansar!",
                "¬°Felicidades! Todas las tareas completadas. ¬°Productividad al m√°ximo!",
                "¬°Incre√≠ble! Has terminado todo por hoy. ¬°Disfruta tu tiempo libre!",
                "Sistema... en modo... celebraci√≥n. ¬°Lo lograste! üéâ"
            ]
        };

        // --- SELECTORES DEL DOM ---
        const mainContent = document.getElementById('main-content');
        const viewButtons = document.querySelectorAll('.view-btn');
        const modalContainer = document.getElementById('modal-container');
        const avatarContainer = document.getElementById('avatar-container');
        const contextMenuContainer = document.getElementById('context-menu-container');
        const htmlEl = document.documentElement;

        // --- INICIALIZACI√ìN ---
        function init() {
            const savedTheme = localStorage.getItem('themeColor');
            if (savedTheme) applyTheme(savedTheme);
            if (localStorage.getItem('darkMode') === 'true') {
                htmlEl.classList.add('dark');
                document.getElementById('sun-icon').classList.remove('hidden');
                document.getElementById('moon-icon').classList.add('hidden');
            }
            renderAll();
        }

        function renderAll() {
            renderCurrentView();
            renderAvatar('auto');
        }

        function renderCurrentView() {
            mainContent.classList.remove('animate-fadeIn');
            void mainContent.offsetWidth;
            mainContent.classList.add('animate-fadeIn');
            switch (currentView) {
                case 'schedule': renderScheduleView(); break;
                case 'daily': renderDailyView(); break;
                case 'weekly': renderWeeklyView(); break;
                case 'monthly': renderMonthlyView(); break;
                case 'goals': renderGoalsView(); break;
                case 'stats': renderStatsView(); break;
                case 'pomodoro': renderPomodoroView(); break;
                default: renderDailyView();
            }
        }

        // --- L√ìGICA DE DATOS ---
        function saveData() {
            localStorage.setItem('tasks', JSON.stringify(tasks));
            localStorage.setItem('goals', JSON.stringify(goals));
            localStorage.setItem('scheduleData', JSON.stringify(scheduleData));
            localStorage.setItem('pomodoroSettings', JSON.stringify(pomodoroSettings));
        }
        
        function updateGoalProgress(goalId) {
            if (!goalId) return;
            const goal = goals.find(g => g.id == goalId);
            if (!goal) return;
            const linkedTasks = tasks.filter(t => t.goalId == goalId);
            const completedTasks = linkedTasks.filter(t => t.completed);
            goal.progress = linkedTasks.length > 0 ? Math.round((completedTasks.length / linkedTasks.length) * 100) : 0;
            saveData();
        }

        function handleRecurrence(task) {
            if (!task.recurrence || task.recurrence === 'none' || !task.completed) return;
            const today = new Date();
            today.setHours(0,0,0,0);
            const taskDate = new Date(task.date);
            taskDate.setHours(2,0,0,0); // Avoid timezone issues
            
            if (taskDate.getTime() > today.getTime()) return;

            const nextDate = new Date(task.date);
            nextDate.setDate(nextDate.getDate() + 1);

            if (task.recurrence === 'daily') {
                nextDate.setDate(nextDate.getDate());
            } else if (task.recurrence === 'weekly') {
                nextDate.setDate(nextDate.getDate() + 6);
            }
            
            const nextDateString = nextDate.toISOString().split('T')[0];
            const originalId = task.originalId || task.id;
            const existingTask = tasks.find(t => (t.originalId === originalId || t.id === originalId) && t.date === nextDateString);

            if(existingTask) return;

            tasks.push({
                ...task,
                id: Date.now(),
                originalId: originalId,
                date: nextDateString,
                completed: false,
                subtasks: task.subtasks.map(st => ({ ...st, completed: false }))
            });
        }
        
        // --- RENDERIZADO DE VISTAS ---
        function renderHeader(title, subtitle, actions = [], progress = null) {
             const buttonsHTML = actions.map(action => {
                 if (action.type === 'add') {
                     return `<button class="add-context-btn bg-[rgb(var(--color-primary-accent))] text-white flex items-center px-4 py-2 rounded-md font-medium hover:opacity-90 transition-all hover:scale-105 shadow-md hover:shadow-lg">
                         <svg class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" /></svg>
                         ${action.text}
                     </button>`;
                 }
                 if (action.type === 'export') {
                      return `<button class="export-pdf-btn bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-200 flex items-center px-4 py-2 rounded-md font-medium hover:bg-slate-300 dark:hover:bg-slate-600 transition-colors" data-view="${action.view}">
                         <svg class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M10 3.5A1.5 1.5 0 0111.5 5v1.618a3.5 3.5 0 015.153 2.533A3.5 3.5 0 0116.5 15H3.5a3.5 3.5 0 01-1.806-6.35A3.5 3.5 0 016.5 5.118V5A1.5 1.5 0 018 3.5h2zM12 5V4H8v1h4z" /></svg>
                         Exportar PDF
                     </button>`;
                 }
                 return '';
             }).join('');

            const progressHTML = progress !== null ? createProgressCircle(progress) : '';

            return `
                <header id="view-header" class="view-header mb-6 bg-white dark:bg-slate-800 p-6 rounded-lg shadow-lg flex flex-col sm:flex-row items-start sm:items-center justify-between animate-fadeInUp">
                    <div class="flex items-center">
                        ${progressHTML}
                        <div class="${progress !== null ? 'ml-4' : ''}">
                            <h2 class="text-2xl sm:text-3xl font-bold">${title}</h2>
                            <p class="text-slate-500 dark:text-slate-400 mt-1">${subtitle}</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2 mt-4 sm:mt-0 self-end sm:self-center">${buttonsHTML}</div>
                </header>
            `;
        }

        function renderDailyView() {
            const todayStr = new Date().toISOString().split('T')[0];
            const todaysTasks = tasks.filter(t => t.date === todayStr);
            const progress = calculateWeightedProgress(todaysTasks);
            let tasksHTML = todaysTasks.length > 0 
                ? todaysTasks.sort((a,b) => (a.startTime || '23:59').localeCompare(b.startTime || '23:59')).map(createTaskCard).join('') 
                : `<div class="text-center py-10 px-6 bg-white dark:bg-slate-800 rounded-lg shadow-sm"><h3 class="text-lg font-medium">¬°Todo despejado por hoy!</h3><p class="text-slate-500 dark:text-slate-400 mt-2">A√±ade una nueva tarea para empezar.</p></div>`;
            
            mainContent.innerHTML = renderHeader('Agenda de Hoy', new Date().toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }), [{type: 'export', view: 'daily'}, {type: 'add', text: 'A√±adir Tarea'}], progress) + `<div id="export-content" class="space-y-4 animate-fadeInUp" style="animation-delay: 100ms;">${tasksHTML}</div>`;
        }
        
        function renderWeeklyView() {
            const today = new Date();
            const dayOfWeek = today.getDay();
            const startOfWeek = new Date(today);
            startOfWeek.setDate(today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1));
            startOfWeek.setHours(0, 0, 0, 0);

            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);
            endOfWeek.setHours(23, 59, 59, 999);
            
            let weekTasks = [];
            let weekHTML = '';
            for (let i = 0; i < 7; i++) {
                const day = new Date(startOfWeek);
                day.setDate(day.getDate() + i);
                const dayString = day.toISOString().split('T')[0];
                const dayTasks = tasks.filter(t => t.date === dayString);
                weekTasks.push(...dayTasks);
                
                const tasksHTML = dayTasks.length > 0 ? dayTasks.sort((a,b) => (a.startTime || '23:59').localeCompare(b.startTime || '23:59')).map(createTaskCard).join('') : '<p class="text-sm text-slate-500 dark:text-slate-400 mt-2">Sin tareas.</p>';

                weekHTML += `<div class="bg-white dark:bg-slate-800 p-4 rounded-lg shadow-md"><h3 class="font-bold">${day.toLocaleDateString('es-ES', { weekday: 'long' })}</h3><p class="text-sm text-slate-500 dark:text-slate-400 mb-4">${day.toLocaleDateString('es-ES', { day: 'numeric', month: 'long' })}</p><div class="space-y-3">${tasksHTML}</div></div>`;
            }
            
            const progress = calculateWeightedProgress(weekTasks);
            mainContent.innerHTML = renderHeader('Vista Semanal', `Del ${startOfWeek.toLocaleDateString('es-ES')} al ${endOfWeek.toLocaleDateString('es-ES')}`, [{type: 'export', view: 'weekly'}, {type: 'add', text: 'A√±adir Tarea'}], progress) + `<div id="export-content" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 animate-fadeInUp" style="animation-delay: 100ms;">${weekHTML}</div>`;
        }
        
        function renderMonthlyView() {
            const today = new Date();
            const month = today.getMonth();
            const year = today.getFullYear();
            const firstDayOfMonth = (new Date(year, month, 1).getDay() + 6) % 7; // Lunes = 0
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            const monthTasks = tasks.filter(t => {
                const taskDate = new Date(t.date);
                return taskDate.getMonth() === month && taskDate.getFullYear() === year;
            });

            let calendarHTML = '<div class="grid grid-cols-7 gap-1">';
            const weekdays = ['Lu', 'Ma', 'Mi', 'Ju', 'Vi', 'S√°', 'Do'];
            weekdays.forEach(day => { calendarHTML += `<div class="text-center font-semibold text-xs text-slate-600 dark:text-slate-400 py-2">${day}</div>`; });
            for (let i = 0; i < firstDayOfMonth; i++) { calendarHTML += '<div></div>'; }
            for (let day = 1; day <= daysInMonth; day++) {
                const dateString = new Date(year, month, day).toISOString().split('T')[0];
                const dayTasks = tasks.filter(t => t.date === dateString);
                const taskDots = dayTasks.slice(0, 3).map(t => `<div class="w-1.5 h-1.5 rounded-full" style="background-color: ${CATEGORIES[t.category]?.color || '#64748b'}"></div>`).join('');
                calendarHTML += `<div class="border border-slate-200 dark:border-slate-700 rounded-md p-1 sm:p-2 h-20 sm:h-24 flex flex-col ${dateString === new Date().toISOString().split('T')[0] ? 'bg-slate-100 dark:bg-slate-700/50' : 'bg-white dark:bg-slate-800'}"><span class="font-medium text-xs sm:text-sm">${day}</span><div class="flex-grow mt-1 space-x-1 flex items-end flex-wrap">${taskDots}</div></div>`;
            }
            calendarHTML += '</div>';
            
            const progress = calculateWeightedProgress(monthTasks);
            mainContent.innerHTML = renderHeader(new Date().toLocaleDateString('es-ES', { month: 'long', year: 'numeric' }), 'Vista Mensual', [{type: 'export', view: 'monthly'}, {type: 'add', text: 'A√±adir Tarea'}], progress) + `<div id="export-content" class="animate-fadeInUp" style="animation-delay: 100ms;">${calendarHTML}</div>`;
        }

        function renderScheduleView() {
            let gridHTML = '<div class="sticky top-0 bg-white dark:bg-slate-800 z-10"></div>'; // Placeholder for time column
            const weekdays = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado', 'Domingo'];
            weekdays.forEach(day => {
                gridHTML += `<div class="sticky top-0 bg-white dark:bg-slate-800 z-10 text-center p-2 border-b border-slate-200 dark:border-slate-700"><p class="font-semibold text-sm">${day.substring(0,3)}</p></div>`;
            });

            for (let i = 0; i < 48; i++) { // 48 slots de 30 minutos
                const hour = Math.floor(i / 2);
                const minute = i % 2 === 0 ? '00' : '30';
                const time = `${String(hour).padStart(2, '0')}:${minute}`;
                
                gridHTML += `<div class="text-right pr-2 text-xs text-slate-400 -mt-2.5">${minute === '00' ? time : ''}</div>`;
                
                for (let d = 0; d < 7; d++) {
                    const key = `d${d}-t${i}`;
                    const cellData = scheduleData[key];
                    const text = cellData?.text || '';
                    const bgColor = cellData?.bgColor || 'transparent';
                    const fontSize = cellData?.fontSize || '12px';
                    const textColor = cellData?.textColor || 'inherit';

                    gridHTML += `
                        <div class="schedule-cell border-r border-b border-slate-100 dark:border-slate-700 text-xs" 
                             data-key="${key}" 
                             data-day="${d}"
                             data-time-slot="${i}"
                             style="background-color: ${bgColor}; font-size: ${fontSize}; color: ${textColor};">
                            ${text}
                            <div class="fill-handle"></div>
                        </div>`;
                }
            }

            mainContent.innerHTML = renderHeader('Horarios', 'Planifica tus bloques de tiempo visualmente', [{type: 'export', view: 'schedule'}]) + `<div id="export-content" class="bg-white dark:bg-slate-800 p-4 rounded-lg shadow-lg overflow-auto" style="height: 70vh;"><div id="schedule-grid-container" class="schedule-grid relative">${gridHTML}</div></div>`;
        }


        function renderGoalsView() {
            let goalsHTML = goals.length > 0
                ? goals.map(createGoalCard).join('')
                : `<div class="text-center py-10 px-6 bg-white dark:bg-slate-800 rounded-lg shadow-sm"><h3 class="text-lg font-medium">Sin metas definidas</h3><p class="text-slate-500 dark:text-slate-400 mt-2">Crea una meta para empezar a progresar.</p></div>`;
            mainContent.innerHTML = renderHeader('Mis Metas', 'Define y sigue tus objetivos a largo plazo', [{type: 'export', view: 'goals'}, {type: 'add', text: 'Nueva Meta'}]) + `<div id="export-content" class="grid grid-cols-1 md:grid-cols-2 gap-6 animate-fadeInUp" style="animation-delay: 100ms;">${goalsHTML}</div>`;
        }

        function renderStatsView() {
            mainContent.innerHTML = renderHeader('Estad√≠sticas', 'Visualiza tu progreso y productividad', []) + `
                <div id="export-content" class="grid grid-cols-1 lg:grid-cols-2 gap-6 animate-fadeInUp" style="animation-delay: 100ms;">
                    <div class="stat-card bg-white dark:bg-slate-800 p-6 rounded-lg shadow-lg"><h3 class="font-bold mb-4">Tareas Completadas (√öltimos 7 d√≠as)</h3><canvas id="completionChart"></canvas></div>
                    <div class="stat-card bg-white dark:bg-slate-800 p-6 rounded-lg shadow-lg"><h3 class="font-bold mb-4">Distribuci√≥n por Categor√≠a</h3><canvas id="categoryChart"></canvas></div>
                </div>
            `;
            renderCharts();
        }

        function renderPomodoroView() {
            const minutes = Math.floor(pomodoro.timeLeft / 60);
            const seconds = pomodoro.timeLeft % 60;

            mainContent.innerHTML = renderHeader('Temporizador Pomodoro', 'Conc√©ntrate en bloques de tiempo', []) + `
                <div id="export-content" class="flex flex-col items-center justify-center bg-white dark:bg-slate-800 p-8 rounded-lg shadow-lg animate-fadeInUp">
                    <div class="text-center">
                        <p class="text-lg font-medium text-slate-500 dark:text-slate-400">${pomodoro.mode === 'work' ? 'Tiempo de Enfoque' : 'Tiempo de Descanso'}</p>
                        <p id="pomo-display-time" class="text-7xl sm:text-8xl font-bold font-mono my-4">${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}</p>
                    </div>
                    <div class="flex space-x-4 my-6">
                        <button id="pomo-start-pause" class="px-8 py-3 text-lg rounded-md bg-[rgb(var(--color-primary-accent))] text-white font-semibold shadow-lg hover:opacity-90 transition-transform hover:scale-105">${pomodoro.isActive ? 'Pausa' : 'Iniciar'}</button>
                        <button id="pomo-reset" class="px-8 py-3 text-lg rounded-md bg-slate-200 dark:bg-slate-700 font-semibold hover:bg-slate-300 dark:hover:bg-slate-600 transition">Reiniciar</button>
                    </div>
                    <div class="mt-8 border-t border-slate-200 dark:border-slate-700 pt-6 w-full max-w-md">
                        <h3 class="text-center font-bold text-lg mb-4">Configuraci√≥n</h3>
                        <div class="flex items-center justify-between space-x-4">
                            <div class="flex-1">
                                <label class="text-sm">Trabajo (min)</label>
                                <input type="number" id="pomo-work-input" value="${pomodoroSettings.work}" class="w-full p-2 mt-1 rounded bg-slate-100 dark:bg-slate-700">
                            </div>
                            <div class="flex-1">
                                <label class="text-sm">Descanso (min)</label>
                                <input type="number" id="pomo-break-input" value="${pomodoroSettings.break}" class="w-full p-2 mt-1 rounded bg-slate-100 dark:bg-slate-700">
                            </div>
                            <button id="pomo-save-settings" class="self-end px-4 py-2 text-sm text-center text-white bg-slate-500 hover:bg-slate-600 rounded-md">Guardar</button>
                        </div>
                    </div>
                </div>
            `;
        }

        // --- RENDERIZADO DE COMPONENTES ---
        function createTaskCard(task) {
            const category = CATEGORIES[task.category];
            const style = category ? `border-left-color: ${category.color};` : 'border-left-color: #64748b;';
            const subtasksHTML = (task.subtasks || []).map((sub, index) => `
                <div class="flex items-center mt-2">
                    <input type="checkbox" id="subtask-${task.id}-${index}" data-task-id="${task.id}" data-subtask-index="${index}" class="subtask-checkbox h-4 w-4 rounded border-slate-300 text-[rgb(var(--color-primary-accent))] focus:ring-[rgb(var(--color-primary-accent))]" ${sub.completed ? 'checked' : ''}>
                    <label for="subtask-${task.id}-${index}" class="ml-2 text-sm ${sub.completed ? 'completed-task text-slate-400' : ''}">${sub.title}</label>
                </div>
            `).join('');

            return `
                <div class="task-card bg-white dark:bg-slate-800 p-4 rounded-lg shadow-md border-l-4" style="${style}" data-task-id="${task.id}">
                    <div class="flex items-start">
                        <input type="checkbox" data-task-id="${task.id}" class="task-checkbox h-5 w-5 rounded border-slate-300 text-[rgb(var(--color-primary-accent))] focus:ring-[rgb(var(--color-primary-accent))] mt-1 cursor-pointer" ${task.completed ? 'checked' : ''}>
                        <div class="ml-3 flex-1 cursor-pointer">
                            <p class="font-medium ${task.completed ? 'completed-task text-slate-500' : ''}"><span class="mr-2">${task.emoji || ''}</span>${task.title}</p>
                            ${task.startTime ? `<p class="text-xs text-slate-500 dark:text-slate-400">${task.startTime} - ${task.endTime || ''}</p>` : ''}
                            <div class="text-xs text-slate-500 dark:text-slate-400 mt-1 flex items-center space-x-2">
                                <span class="bg-slate-100 dark:bg-slate-700 px-2 py-0.5 rounded-full font-medium">Valor: ${task.value}</span>
                                ${goals.find(g => g.id == task.goalId) ? `<span class="bg-slate-100 dark:bg-slate-700 px-2 py-0.5 rounded-full font-medium">${goals.find(g => g.id == task.goalId).title}</span>` : ''}
                            </div>
                            <div class="mt-2">${subtasksHTML}</div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function createGoalCard(goal) {
            return `
                <div class="goal-card bg-white dark:bg-slate-800 p-6 rounded-lg shadow-lg cursor-pointer" data-goal-id="${goal.id}">
                    <div class="flex justify-between items-start">
                        <h3 class="font-bold text-lg">${goal.title}</h3>
                        <span class="text-2xl font-bold text-[rgb(var(--color-primary-accent))]">${Math.round(goal.progress || 0)}%</span>
                    </div>
                    <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">${goal.description}</p>
                    <div class="mt-4 bg-slate-200 dark:bg-slate-700 rounded-full h-2.5">
                        <div class="bg-[rgb(var(--color-primary-accent))] h-2.5 rounded-full" style="width: ${goal.progress || 0}%"></div>
                    </div>
                </div>
            `;
        }

        function renderCharts() {
            const today = new Date();
            const last7Days = Array.from({length: 7}, (_, i) => {
                const d = new Date(today);
                d.setDate(d.getDate() - i);
                return d.toISOString().split('T')[0];
            }).reverse();

            const completionData = last7Days.map(date => tasks.filter(t => t.date === date && t.completed).length);
            
            new Chart(document.getElementById('completionChart'), {
                type: 'line',
                data: { labels: last7Days.map(d => new Date(d).toLocaleDateString('es-ES', {weekday: 'short'})), datasets: [{ label: 'Tareas Completadas', data: completionData, borderColor: `rgb(var(--color-primary-accent))`, tension: 0.1 }] },
                options: { scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
            });

            const categoryData = Object.keys(CATEGORIES).map(key => tasks.filter(t => t.category === key).length);
            new Chart(document.getElementById('categoryChart'), {
                type: 'doughnut',
                data: { labels: Object.values(CATEGORIES).map(c => c.label), datasets: [{ label: 'Distribuci√≥n', data: categoryData, backgroundColor: Object.values(CATEGORIES).map(c => c.color) }] }
            });
        }
        
        function updatePomodoroDisplay() {
            if (currentView !== 'pomodoro') return;
            const display = document.getElementById('pomo-display-time');
            if (display) {
                const minutes = Math.floor(pomodoro.timeLeft / 60);
                const seconds = pomodoro.timeLeft % 60;
                display.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }
        }

        function renderAvatar(face = 'neutral', message = '') {
            const todayStr = new Date().toISOString().split('T')[0];
            const todaysTasks = tasks.filter(t => t.date === todayStr);
            const completedCount = todaysTasks.filter(t => t.completed).length;
            const totalCount = todaysTasks.length;
            
            let currentFace = face;
            let currentMessage = message;

            const getRandomMessage = (arr) => arr[Math.floor(Math.random() * arr.length)];

            if (face === 'auto') {
                if (totalCount === 0) {
                    currentFace = 'neutral';
                    currentMessage = getRandomMessage(MESSAGES.noTasks);
                } else {
                    const percentage = (completedCount / totalCount) * 100;
                    if (percentage === 100) {
                        currentFace = 'satisfied';
                        currentMessage = getRandomMessage(MESSAGES.allDone);
                    } else if (percentage >= 75) {
                        currentFace = 'satisfied';
                        currentMessage = getRandomMessage(MESSAGES.almostDone);
                    } else if (percentage > 0) {
                        currentFace = 'happy';
                        currentMessage = getRandomMessage(MESSAGES.inProgress).replace('${completedCount}', completedCount).replace('${totalCount}', totalCount);
                    } else {
                        currentFace = 'neutral';
                        currentMessage = getRandomMessage(MESSAGES.startDay);
                    }
                }
            }
            
            const faces = {
                neutral: `<path d="M8 12 H12 M18 12 H22 M15 17 C15 17 12 19 9 17" />`,
                happy: `<path d="M8 12 C8 11 9 10 10 10 C11 10 12 11 12 12 M18 12 C18 11 19 10 20 10 C21 10 22 11 22 12 M15 19 C15 19 12 22 9 19" />`,
                satisfied: `<path d="M9 11 C9 11 10 13 11 11 M19 11 C19 11 20 13 21 11 M15 19 C15 19 12 22 9 19" />`,
            };

            avatarContainer.innerHTML = `
                <div class="bg-white dark:bg-slate-800 p-2 rounded-lg shadow-lg relative bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-700 dark:to-slate-800">
                    <div id="avatar-speech-bubble" class="absolute bottom-full mb-2 w-48 bg-white dark:bg-slate-700 text-sm p-3 rounded-lg shadow-xl">${currentMessage}</div>
                    <svg id="robot-avatar" width="60" height="60" viewBox="0 0 30 30" class="fill-none stroke-current text-slate-600 dark:text-slate-300" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="5" y="8" width="20" height="15" rx="2" />
                        <circle cx="10" cy="12" r="0.5" fill="currentColor" />
                        <circle cx="20" cy="12" r="0.5" fill="currentColor" />
                        ${faces[currentFace]}
                        <path d="M12 8 V5 A1 1 0 0 1 13 4 H17 A1 1 0 0 1 18 5 V8" />
                    </svg>
                </div>
            `;
        }

        // --- L√ìGICA DE POMODORO ---
        function handlePomodoro() {
            pomodoro.isActive = !pomodoro.isActive;
            if (pomodoro.isActive) {
                pomodoro.timer = setInterval(() => {
                    pomodoro.timeLeft--;
                    if (pomodoro.timeLeft < 0) {
                        clearInterval(pomodoro.timer);
                        pomodoro.isActive = false;
                        new Audio("https://assets.mixkit.co/sfx/preview/mixkit-positive-notification-951.mp3").play();
                        pomodoro.mode = pomodoro.mode === 'work' ? 'break' : 'work';
                        pomodoro.timeLeft = (pomodoro.mode === 'work' ? pomodoroSettings.work : pomodoroSettings.break) * 60;
                        if(currentView === 'pomodoro') renderCurrentView();
                    } else {
                        updatePomodoroDisplay();
                    }
                }, 1000);
            } else {
                clearInterval(pomodoro.timer);
            }
            if(currentView === 'pomodoro') {
                const startPauseBtn = document.getElementById('pomo-start-pause');
                if (startPauseBtn) startPauseBtn.textContent = pomodoro.isActive ? 'Pausa' : 'Iniciar';
            }
        }

        function resetPomodoro(useSettings = false) {
            clearInterval(pomodoro.timer);
            pomodoro.isActive = false;
            if (useSettings) {
                pomodoroSettings.work = parseInt(document.getElementById('pomo-work-input').value) || 25;
                pomodoroSettings.break = parseInt(document.getElementById('pomo-break-input').value) || 5;
                saveData();
            }
            pomodoro.mode = 'work';
            pomodoro.timeLeft = pomodoroSettings.work * 60;
            if(currentView === 'pomodoro') renderCurrentView();
        }
        
        // --- L√ìGICA DE MODALES ---
        function openModal(content) {
            modalContainer.innerHTML = `<div class="modal-backdrop fixed inset-0 bg-slate-900 bg-opacity-50 z-50 flex items-center justify-center p-4 opacity-0"><div class="modal-content bg-white dark:bg-slate-800 rounded-lg shadow-2xl w-full max-w-lg p-6 transform scale-95">${content}</div></div>`;
            setTimeout(() => {
                modalContainer.querySelector('.modal-backdrop').classList.remove('opacity-0');
                modalContainer.querySelector('.modal-content').classList.remove('scale-95');
            }, 10);
        }

        function closeModal() {
            const backdrop = modalContainer.querySelector('.modal-backdrop');
            if (backdrop) {
                backdrop.classList.add('opacity-0');
                backdrop.querySelector('.modal-content').classList.add('scale-95');
                setTimeout(() => { modalContainer.innerHTML = ''; }, 300);
            }
        }

        function openTaskModal(task = null) {
            const isEditing = task !== null;
            const categoryOptions = Object.entries(CATEGORIES).map(([key, value]) => `<option value="${key}" ${task?.category === key ? 'selected' : ''}>${value.label}</option>`).join('');
            const goalOptions = goals.map(g => `<option value="${g.id}" ${task?.goalId == g.id ? 'selected' : ''}>${g.title}</option>`).join('');
            const subtasksHTML = (task?.subtasks || []).map(sub => `
                <div class="flex items-center space-x-2">
                    <input type="checkbox" class="h-4 w-4 rounded border-slate-300 text-[rgb(var(--color-primary-accent))] focus:ring-[rgb(var(--color-primary-accent))]" ${sub.completed ? 'checked' : ''}>
                    <input type="text" class="flex-1 border-b border-slate-300 dark:border-slate-600 focus:border-[rgb(var(--color-primary-accent))] focus:outline-none py-1 bg-transparent" placeholder="Describe el paso..." value="${sub.title}">
                    <button type="button" class="remove-subtask text-slate-400 hover:text-rose-500">&times;</button>
                </div>`).join('');

            const modalContent = `
                <div class="flex justify-between items-center pb-3 border-b border-slate-200 dark:border-slate-700">
                    <h3 class="text-xl font-semibold">${isEditing ? 'Editar Tarea' : 'Nueva Tarea'}</h3>
                    <button class="close-modal-btn text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 text-2xl">&times;</button>
                </div>
                <form id="taskForm" class="mt-4 space-y-4 max-h-[70vh] overflow-y-auto pr-2">
                    <input type="hidden" id="taskId" value="${task?.id || ''}">
                    <div class="flex space-x-2">
                        <input type="text" id="taskEmoji" class="w-12 p-2 text-center rounded bg-slate-100 dark:bg-slate-700" value="${task?.emoji || ''}" maxlength="2">
                        <input type="text" id="taskTitle" class="flex-1 w-full p-2 rounded bg-slate-100 dark:bg-slate-700" placeholder="T√≠tulo de la tarea" value="${task?.title || ''}" required>
                    </div>
                    <textarea id="taskNotes" class="w-full p-2 rounded bg-slate-100 dark:bg-slate-700" placeholder="A√±adir notas...">${task?.notes || ''}</textarea>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <input type="date" id="taskDate" value="${task?.date || new Date().toISOString().split('T')[0]}" class="w-full p-2 rounded bg-slate-100 dark:bg-slate-700 col-span-1">
                        <input type="time" id="taskStartTime" step="1800" value="${task?.startTime || ''}" class="w-full p-2 rounded bg-slate-100 dark:bg-slate-700">
                        <input type="time" id="taskEndTime" step="1800" value="${task?.endTime || ''}" class="w-full p-2 rounded bg-slate-100 dark:bg-slate-700">
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <select id="taskCategory" class="w-full p-2 rounded bg-slate-100 dark:bg-slate-700"><option value="">Categor√≠a</option>${categoryOptions}</select>
                        <select id="taskGoal" class="w-full p-2 rounded bg-slate-100 dark:bg-slate-700"><option value="">Vincular a meta</option>${goalOptions}</select>
                    </div>
                     <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <input type="number" id="taskValue" min="1" max="10" value="${task?.value || 5}" class="w-full p-2 rounded bg-slate-100 dark:bg-slate-700" placeholder="Valor (1-10)">
                        <select id="taskRecurrence" class="w-full p-2 rounded bg-slate-100 dark:bg-slate-700">
                            <option value="none" ${task?.recurrence === 'none' ? 'selected' : ''}>No se repite</option>
                            <option value="daily" ${task?.recurrence === 'daily' ? 'selected' : ''}>Diariamente</option>
                            <option value="weekly" ${task?.recurrence === 'weekly' ? 'selected' : ''}>Semanalmente</option>
                        </select>
                    </div>
                     <div>
                        <h4 class="text-sm font-medium text-slate-700 dark:text-slate-300">Subtareas</h4>
                        <div id="subtasksContainer" class="mt-2 space-y-2">${subtasksHTML}</div>
                        <button type="button" id="addSubtaskBtn" class="mt-2 text-sm text-[rgb(var(--color-primary-accent))] hover:opacity-80 font-medium">+ A√±adir paso</button>
                    </div>
                    <div class="flex justify-end pt-4 space-x-2">
                        ${isEditing ? `<button type="button" id="deleteTaskBtn" class="bg-rose-500 text-white px-4 py-2 rounded-md font-medium hover:bg-rose-600" data-id="${task.id}">Eliminar</button>` : ''}
                        <button type="submit" class="bg-[rgb(var(--color-primary-accent))] text-white px-4 py-2 rounded-md font-medium">Guardar</button>
                    </div>
                </form>
            `;
            openModal(modalContent);
            document.getElementById('taskTitle').addEventListener('input', autoCategorize);
        }

        function openGoalModal(goal = null) {
            const isEditing = goal !== null;
            const modalContent = `
                <div class="flex justify-between items-center pb-3 border-b border-slate-200 dark:border-slate-700">
                    <h3 class="text-xl font-semibold">${isEditing ? 'Editar Meta' : 'Nueva Meta'}</h3>
                    <button class="close-modal-btn text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 text-2xl">&times;</button>
                </div>
                <form id="goalForm" class="mt-4 space-y-4">
                    <input type="hidden" id="goalId" value="${goal?.id || ''}">
                    <input type="text" id="goalTitle" class="w-full p-2 rounded bg-slate-100 dark:bg-slate-700" placeholder="T√≠tulo de la meta" value="${goal?.title || ''}" required>
                    <textarea id="goalDescription" class="w-full p-2 rounded bg-slate-100 dark:bg-slate-700" placeholder="Describe tu meta...">${goal?.description || ''}</textarea>
                    <div class="flex justify-end pt-4 space-x-2">
                        ${isEditing ? `<button type="button" id="deleteGoalBtn" class="bg-rose-500 text-white px-4 py-2 rounded-md font-medium hover:bg-rose-600" data-id="${goal.id}">Eliminar</button>` : ''}
                        <button type="submit" class="bg-[rgb(var(--color-primary-accent))] text-white px-4 py-2 rounded-md font-medium">Guardar</button>
                    </div>
                </form>
            `;
            openModal(modalContent);
        }

        function openConfirmDeleteModal() {
            const modalContent = `
                <h3 class="text-lg font-bold">¬øEst√°s seguro?</h3>
                <p class="text-sm text-slate-600 dark:text-slate-400 mt-2">Esta acci√≥n es irreversible y eliminar√° todas tus tareas y metas. ¬øDeseas continuar?</p>
                <div class="flex justify-end mt-6 space-x-3">
                    <button class="close-modal-btn bg-slate-200 text-slate-800 px-4 py-2 rounded-md font-medium hover:bg-slate-300">Cancelar</button>
                    <button id="confirmDeleteYes" class="bg-rose-500 text-white px-4 py-2 rounded-md font-medium hover:bg-rose-600">S√≠, eliminar todo</button>
                </div>
            `;
            openModal(modalContent);
        }

        // --- L√ìGICA DE EVENTOS ---
        
        let avatarTestState = 0;
        document.body.addEventListener('click', (e) => {
            if (!e.target.closest('.context-menu')) {
                closeContextMenu();
            }

            if (e.target.matches('.close-modal-btn')) closeModal();
            if (e.target.matches('.modal-backdrop')) closeModal();

            if (e.target.closest('#avatar-container')) {
                const states = ['neutral', 'happy', 'satisfied'];
                const messages = [
                    "Soy Flowy, ¬°listo para ayudarte a ser productivo!",
                    "¬°Cada tarea completada es una victoria!",
                    "¬°Un d√≠a bien organizado es un d√≠a exitoso!"
                ];
                avatarTestState = (avatarTestState + 1) % states.length;
                renderAvatar(states[avatarTestState], messages[avatarTestState]);
            }

            if (e.target.closest('.task-card') && !e.target.matches('.task-checkbox') && !e.target.matches('.subtask-checkbox')) {
                openTaskModal(tasks.find(t => t.id == e.target.closest('.task-card').dataset.taskId));
            }
            if (e.target.matches('.task-checkbox')) {
                const task = tasks.find(t => t.id == e.target.dataset.taskId);
                task.completed = e.target.checked;
                if (task.completed) {
                    handleRecurrence(task);
                    renderAvatar('happy');
                    setTimeout(() => renderAvatar('auto'), 2000);
                } else {
                    renderAvatar('auto');
                }
                updateGoalProgress(task.goalId);
                saveData();
                renderCurrentView();
            }
            if (e.target.matches('.subtask-checkbox')) {
                const { taskId, subtaskIndex } = e.target.dataset;
                const task = tasks.find(t => t.id == taskId);
                task.subtasks[subtaskIndex].completed = e.target.checked;
                saveData();
                renderCurrentView();
            }
            if (e.target.id === 'deleteTaskBtn') {
                const id = e.target.dataset.id;
                tasks = tasks.filter(t => t.id != id);
                saveData();
                closeModal();
                renderCurrentView();
            }

            if (e.target.closest('.goal-card')) openGoalModal(goals.find(g => g.id == e.target.closest('.goal-card').dataset.goalId));
            if (e.target.id === 'deleteGoalBtn') {
                const id = e.target.dataset.id;
                goals = goals.filter(g => g.id != id);
                tasks.forEach(t => { if (t.goalId == id) t.goalId = ''; });
                saveData();
                closeModal();
                renderCurrentView();
            }

            if (e.target.id === 'pomo-start-pause') handlePomodoro();
            if (e.target.id === 'pomo-reset') resetPomodoro();
            if (e.target.id === 'pomo-save-settings') {
                resetPomodoro(true);
            }

            const viewBtn = e.target.closest('.view-btn');
            if (viewBtn) {
                e.preventDefault();
                currentView = viewBtn.id.split('-')[1];
                viewButtons.forEach(b => {
                    b.classList.remove('bg-[rgba(var(--color-primary-light))]', 'text-[rgb(var(--color-primary-accent))]');
                    b.classList.add('text-slate-600', 'dark:text-slate-300', 'hover:bg-slate-100', 'dark:hover:bg-slate-700');
                });
                viewBtn.classList.add('bg-[rgba(var(--color-primary-light))]', 'text-[rgb(var(--color-primary-accent))]');
                renderCurrentView();
            }
            if (e.target.closest('.add-context-btn')) {
                if (currentView === 'goals') openGoalModal();
                else openTaskModal();
            }
             if (e.target.closest('#deleteAllBtn')) openConfirmDeleteModal();
             if (e.target.id === 'confirmDeleteYes') {
                tasks = [];
                goals = [];
                scheduleData = {};
                saveData();
                closeModal();
                renderAll();
             }
            if (e.target.closest('.task-block')) {
                const task = tasks.find(t => t.id == e.target.closest('.task-block').dataset.taskId);
                openTaskModal(task);
            }

            if (e.target.closest('#dark-mode-toggle')) {
                htmlEl.classList.toggle('dark');
                document.getElementById('sun-icon').classList.toggle('hidden');
                document.getElementById('moon-icon').classList.toggle('hidden');
                localStorage.setItem('darkMode', htmlEl.classList.contains('dark'));
                renderCurrentView();
            }
            const themeDot = e.target.closest('.theme-dot');
            if (themeDot) {
                applyTheme(themeDot.dataset.color);
                localStorage.setItem('themeColor', themeDot.dataset.color);
            }

            if (e.target.id === 'addSubtaskBtn') {
                const container = document.getElementById('subtasksContainer');
                const div = document.createElement('div');
                div.className = 'flex items-center space-x-2';
                div.innerHTML = `
                    <input type="checkbox" class="h-4 w-4 rounded border-slate-300 text-[rgb(var(--color-primary-accent))] focus:ring-[rgb(var(--color-primary-accent))]">
                    <input type="text" class="flex-1 border-b border-slate-300 dark:border-slate-600 focus:border-[rgb(var(--color-primary-accent))] focus:outline-none py-1 bg-transparent" placeholder="Describe el paso...">
                    <button type="button" class="remove-subtask text-slate-400 hover:text-rose-500">&times;</button>
                `;
                container.appendChild(div);
            }
            if (e.target.matches('.remove-subtask')) {
                e.target.parentElement.remove();
            }
            
            if(e.target.closest('.export-pdf-btn')) {
                exportViewAsPDF(e.target.closest('.export-pdf-btn').dataset.view);
            }
            
            if (e.target.closest('#fullscreen-toggle')) {
                toggleFullScreen();
            }
            
            if (e.target.matches('.schedule-cell')) {
                document.querySelectorAll('.schedule-cell.selected').forEach(cell => cell.classList.remove('selected'));
                e.target.classList.add('selected');
            }
        });

        modalContainer.addEventListener('submit', (e) => {
            e.preventDefault();
            if (e.target.id === 'taskForm') {
                const id = e.target.querySelector('#taskId').value;
                const subtasks = Array.from(e.target.querySelectorAll('#subtasksContainer .flex')).map(div => ({
                    title: div.querySelector('input[type="text"]').value,
                    completed: div.querySelector('input[type="checkbox"]').checked
                })).filter(s => s.title);

                const taskData = {
                    title: e.target.querySelector('#taskTitle').value,
                    emoji: e.target.querySelector('#taskEmoji').value,
                    notes: e.target.querySelector('#taskNotes').value,
                    date: e.target.querySelector('#taskDate').value,
                    startTime: e.target.querySelector('#taskStartTime').value,
                    endTime: e.target.querySelector('#taskEndTime').value,
                    value: parseInt(e.target.querySelector('#taskValue').value),
                    category: e.target.querySelector('#taskCategory').value,
                    goalId: e.target.querySelector('#taskGoal').value,
                    recurrence: e.target.querySelector('#taskRecurrence').value,
                    subtasks: subtasks,
                };
                if (id) {
                    const taskIndex = tasks.findIndex(t => t.id == id);
                    const oldGoalId = tasks[taskIndex].goalId;
                    tasks[taskIndex] = { ...tasks[taskIndex], ...taskData };
                    if (oldGoalId !== taskData.goalId) updateGoalProgress(oldGoalId);
                } else {
                    tasks.push({ id: Date.now(), completed: false, ...taskData });
                }
                updateGoalProgress(taskData.goalId);
            }
            if (e.target.id === 'goalForm') {
                const id = e.target.querySelector('#goalId').value;
                const goalData = {
                    title: e.target.querySelector('#goalTitle').value,
                    description: e.target.querySelector('#goalDescription').value,
                };
                if (id) {
                    const goalIndex = goals.findIndex(g => g.id == id);
                    goals[goalIndex] = { ...goals[goalIndex], ...goalData };
                } else {
                    goals.push({ id: Date.now(), progress: 0, ...goalData });
                }
            }
            saveData();
            closeModal();
            renderAll();
        });

        function autoCategorize(event) {
            const title = event.target.value.toLowerCase();
            const categorySelect = document.getElementById('taskCategory');
            const emojiInput = document.getElementById('taskEmoji');

            for (const [key, value] of Object.entries(CATEGORIES)) {
                if (value.keywords.some(k => title.includes(k))) {
                    categorySelect.value = key;
                    if (!emojiInput.value) emojiInput.value = value.emoji;
                    return;
                }
            }
        }

        function applyTheme(color) {
            htmlEl.style.setProperty('--color-primary', color);
            htmlEl.style.setProperty('--color-primary-accent', color);
            document.querySelectorAll('.theme-dot').forEach(dot => {
                dot.classList.remove('ring-2', 'ring-offset-2', 'ring-offset-white', 'dark:ring-offset-slate-800');
                dot.style.borderColor = 'transparent';
                if (dot.dataset.color === color) {
                    dot.classList.add('ring-2', 'ring-offset-2', 'ring-offset-white', 'dark:ring-offset-slate-800');
                    dot.style.borderColor = `rgb(${color})`;
                }
            });
        }
        
        function exportViewAsPDF(view) {
            const { jsPDF } = window.jspdf;
            const elementToCapture = document.getElementById('main-content');
            
            const pdfSpinner = document.createElement('div');
            pdfSpinner.innerHTML = `<div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; color: white; font-size: 1.2rem;">Generando PDF...</div>`;
            document.body.appendChild(pdfSpinner);

            html2canvas(elementToCapture, {
                scale: 2,
                useCORS: true,
                backgroundColor: htmlEl.classList.contains('dark') ? '#0f172a' : '#f8fafc',
                onclone: (document) => {
                    if (htmlEl.classList.contains('dark')) {
                        document.documentElement.classList.add('dark');
                    }
                }
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF({
                    orientation: 'p',
                    unit: 'px',
                    format: 'a4',
                    hotfixes: ['px_scaling']
                });

                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
                
                pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                pdf.save(`FocusFlow-${view}.pdf`);
                document.body.removeChild(pdfSpinner);
            }).catch(err => {
                console.error("Error exporting to PDF:", err);
                document.body.removeChild(pdfSpinner);
            });
        }
        
        function toggleFullScreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        }
        
        document.addEventListener('fullscreenchange', () => {
            const isFullscreen = !!document.fullscreenElement;
            document.getElementById('icon-enter-fullscreen').classList.toggle('hidden', isFullscreen);
            document.getElementById('icon-exit-fullscreen').classList.toggle('hidden', !isFullscreen);
        });

        // --- NUEVA L√ìGICA PARA EL HORARIO INTERACTIVO ---
        
        function closeContextMenu() {
            contextMenuContainer.innerHTML = '';
        }

        function openContextMenu(e, cell) {
            e.preventDefault();
            closeContextMenu();
            
            const menu = document.createElement('div');
            menu.className = 'context-menu';
            menu.style.left = `${e.pageX}px`;
            menu.style.top = `${e.pageY}px`;

            const colors = ['#fecaca', '#fed7aa', '#fef08a', '#d9f99d', '#bfdbfe', '#e9d5ff', '#fbcfe8', '#ffffff'];
            const colorPaletteHTML = colors.map(color => `<div class="color-swatch" style="background-color:${color};" data-color="${color}"></div>`).join('');

            menu.innerHTML = `
                <div class="context-menu-item" data-action="change-text">
                    <svg class="h-4 w-4 mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                    Cambiar Texto
                </div>
                <div class="context-menu-item" data-action="change-color">
                     <svg class="h-4 w-4 mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M10 2a.75.75 0 01.75.75v1.5a.75.75 0 01-1.5 0v-1.5A.75.75 0 0110 2zM10 15a.75.75 0 01.75.75v1.5a.75.75 0 01-1.5 0v-1.5A.75.75 0 0110 15zM10 7a3 3 0 100 6 3 3 0 000-6z" /><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-1.414 1.414a1 1 0 01-1.414-1.414l1.414-1.414a1 1 0 011.414 0zM5.293 16.707a1 1 0 010-1.414l1.414-1.414a1 1 0 111.414 1.414L6.707 16.707a1 1 0 01-1.414 0zM17 10a.75.75 0 01-.75.75h-1.5a.75.75 0 010-1.5h1.5a.75.75 0 01.75.75zM4 10a.75.75 0 01-.75.75H2a.75.75 0 010-1.5h1.25a.75.75 0 01.75.75zM14.707 14.707a1 1 0 01-1.414 0l-1.414-1.414a1 1 0 011.414-1.414l1.414 1.414a1 1 0 010 1.414zM6.707 6.707a1 1 0 01-1.414 0L3.879 5.293a1 1 0 111.414-1.414L6.707 5.293a1 1 0 010 1.414z" clip-rule="evenodd" /></svg>
                    Cambiar Color
                </div>
                <div class="color-palette">${colorPaletteHTML}</div>
            `;
            contextMenuContainer.appendChild(menu);

            menu.addEventListener('click', (menuEvent) => {
                const action = menuEvent.target.closest('[data-action]')?.dataset.action;
                const color = menuEvent.target.closest('[data-color]')?.dataset.color;
                
                if (action === 'change-text') {
                    openScheduleCellModal(cell);
                    closeContextMenu();
                }
                if (color) {
                    updateCellData(cell.dataset.key, { bgColor: color });
                    cell.style.backgroundColor = color;
                    saveData();
                    closeContextMenu();
                }
            });
        }
        
        function openScheduleCellModal(cell) {
            const key = cell.dataset.key;
            const cellData = scheduleData[key] || {};
            const emojis = ['üòä', 'üöÄ', 'üíº', 'üìö', 'üí™', 'üè†', '‚úÖ', '‚ùå', 'üî•', 'üí°', 'üéâ', 'üìå', 'üìû', '‚òï', 'üçï', 'üèÉ'];
            const emojiBoardHTML = emojis.map(emoji => `<button type="button" class="emoji-btn text-2xl p-1 rounded-md hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors">${emoji}</button>`).join('');
            
            const textColors = ['#1e293b', '#f8fafc', '#64748b', '#ef4444', '#22c55e', '#3b82f6', '#8b5cf6', '#ec4899'];
            const textColorPaletteHTML = textColors.map(color => `<div class="color-swatch text-color-swatch" style="background-color:${color};" data-color="${color}"></div>`).join('');

            const modalContent = `
                <h3 class="text-xl font-semibold mb-4">Editar Celda</h3>
                <form id="scheduleCellForm">
                    <div class="mb-4">
                        <label for="cellText" class="block text-sm font-medium mb-1">Texto</label>
                        <input type="text" id="cellText" value="${cellData.text || ''}" class="w-full p-2 rounded bg-slate-100 dark:bg-slate-700">
                    </div>
                    <div class="mb-4">
                        <label for="cellFontSize" class="block text-sm font-medium mb-1">Tama√±o de letra (px)</label>
                        <input type="number" id="cellFontSize" value="${(cellData.fontSize || '12px').replace('px','')}" class="w-full p-2 rounded bg-slate-100 dark:bg-slate-700">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-2">Color de Letra</label>
                        <div class="flex items-center gap-2">
                            <input type="color" id="cellTextColor" value="${cellData.textColor || '#1e293b'}" class="w-10 h-10 p-1 bg-transparent border-none rounded-md cursor-pointer">
                            <div class="color-palette !grid-cols-8 !mt-0">${textColorPaletteHTML}</div>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-2">A√±adir Emoji</label>
                        <div class="grid grid-cols-8 gap-1 p-2 bg-slate-100 dark:bg-slate-700 rounded-lg">
                            ${emojiBoardHTML}
                        </div>
                    </div>
                    <div class="flex justify-end pt-4 space-x-2 border-t border-slate-200 dark:border-slate-700">
                        <button type="button" class="close-modal-btn bg-slate-200 text-slate-800 px-4 py-2 rounded-md font-medium hover:bg-slate-300">Cancelar</button>
                        <button type="submit" class="bg-[rgb(var(--color-primary-accent))] text-white px-4 py-2 rounded-md font-medium">Guardar</button>
                    </div>
                </form>
            `;
            openModal(modalContent);

            document.querySelectorAll('.emoji-btn').forEach(btn => {
                btn.onclick = () => {
                    const textInput = document.getElementById('cellText');
                    textInput.value += btn.textContent;
                    textInput.focus();
                };
            });
            document.querySelectorAll('.text-color-swatch').forEach(swatch => {
                swatch.onclick = () => {
                    document.getElementById('cellTextColor').value = swatch.dataset.color;
                };
            });

            document.getElementById('scheduleCellForm').onsubmit = (e) => {
                e.preventDefault();
                const text = document.getElementById('cellText').value;
                const fontSize = document.getElementById('cellFontSize').value + 'px';
                const textColor = document.getElementById('cellTextColor').value;
                
                updateCellData(key, { text, fontSize, textColor });
                cell.textContent = text;
                cell.style.fontSize = fontSize;
                cell.style.color = textColor;
                
                if (!cell.querySelector('.fill-handle')) {
                    const handle = document.createElement('div');
                    handle.className = 'fill-handle';
                    cell.appendChild(handle);
                }
                saveData();
                closeModal();
            };
        }

        function updateCellData(key, newData) {
            scheduleData[key] = { ...(scheduleData[key] || {}), ...newData };
        }

        // --- NUEVAS FUNCIONES PARA EL C√çRCULO DE PROGRESO ---
        function calculateWeightedProgress(tasksArray) {
            if (!tasksArray || tasksArray.length === 0) return 0;
            const totalValue = tasksArray.reduce((sum, task) => sum + (task.value || 0), 0);
            if (totalValue === 0) return 0;
            const completedValue = tasksArray
                .filter(task => task.completed)
                .reduce((sum, task) => sum + (task.value || 0), 0);
            return Math.round((completedValue / totalValue) * 100);
        }

        function createProgressCircle(percentage) {
            const size = 50;
            const strokeWidth = 5;
            const radius = (size / 2) - (strokeWidth * 2);
            const circumference = radius * 2 * Math.PI;
            const offset = circumference - (percentage / 100) * circumference;

            return `
                <div class="relative w-12 h-12">
                    <svg class="w-full h-full" viewBox="0 0 ${size} ${size}">
                        <circle class="progress-circle-bg" stroke-width="${strokeWidth}" cx="${size/2}" cy="${size/2}" r="${radius}"></circle>
                        <circle class="progress-circle-fg" stroke-width="${strokeWidth}" stroke-dasharray="${circumference}" stroke-dashoffset="${offset}" cx="${size/2}" cy="${size/2}" r="${radius}"></circle>
                    </svg>
                    <span class="absolute inset-0 flex items-center justify-center text-xs font-bold text-[rgb(var(--color-primary-accent))]">${percentage}%</span>
                </div>
            `;
        }


        // Eventos para horario
        let isFilling = false;
        let fillStartCell = null;

        document.body.addEventListener('contextmenu', (e) => {
            if (e.target.matches('.schedule-cell')) {
                openContextMenu(e, e.target);
            }
        });

        document.body.addEventListener('mousedown', (e) => {
            if (e.target.matches('.fill-handle')) {
                isFilling = true;
                fillStartCell = e.target.closest('.schedule-cell');
                e.preventDefault(); // Prevent text selection
            }
        });

        document.body.addEventListener('mouseover', (e) => {
            if (isFilling && e.target.matches('.schedule-cell')) {
                document.querySelectorAll('.cell-highlight-fill').forEach(c => c.classList.remove('cell-highlight-fill'));
                
                const startDay = parseInt(fillStartCell.dataset.day);
                const startTimeSlot = parseInt(fillStartCell.dataset.timeSlot);
                const currentDay = parseInt(e.target.dataset.day);
                const currentTimeSlot = parseInt(e.target.dataset.timeSlot);

                if (startDay === currentDay && currentTimeSlot >= startTimeSlot) {
                    for (let i = startTimeSlot; i <= currentTimeSlot; i++) {
                        const cellToHighlight = document.querySelector(`.schedule-cell[data-day='${startDay}'][data-time-slot='${i}']`);
                        if (cellToHighlight) {
                            cellToHighlight.classList.add('cell-highlight-fill');
                        }
                    }
                }
            }
        });

        document.body.addEventListener('mouseup', (e) => {
            if (isFilling) {
                const fillSourceData = scheduleData[fillStartCell.dataset.key] || { 
                    text: fillStartCell.childNodes[0].nodeValue.trim(), 
                    bgColor: fillStartCell.style.backgroundColor, 
                    fontSize: fillStartCell.style.fontSize,
                    textColor: fillStartCell.style.color
                };
                
                document.querySelectorAll('.cell-highlight-fill').forEach(cell => {
                    updateCellData(cell.dataset.key, fillSourceData);
                    cell.childNodes[0].nodeValue = fillSourceData.text || '';
                    cell.style.backgroundColor = fillSourceData.bgColor || 'transparent';
                    cell.style.fontSize = fillSourceData.fontSize || '12px';
                    cell.style.color = fillSourceData.textColor || 'inherit';

                    if (!cell.querySelector('.fill-handle')) {
                        const handle = document.createElement('div');
                        handle.className = 'fill-handle';
                        cell.appendChild(handle);
                    }
                    cell.classList.remove('cell-highlight-fill');
                });
                
                saveData();
                isFilling = false;
                fillStartCell = null;
            }
        });


        // --- INICIALIZAR LA APP ---
        init();
    });
    </script>
</body>
</html>
